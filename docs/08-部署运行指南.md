# 部署运行指南

## 概述

本指南详细说明了如何在不同环境下部署和运行链上数据系统，包括开发环境搭建、测试网部署、生产环境配置和运维监控等。

## 系统要求

### 最低配置要求

**开发环境**:
- Node.js >= 18.0.0
- npm >= 8.0.0 或 yarn >= 1.22.0
- Git >= 2.30.0
- 可用内存 >= 4GB
- 硬盘空间 >= 10GB

**生产环境**:
- Node.js >= 18.0.0 (LTS版本)
- 内存 >= 8GB
- 硬盘空间 >= 50GB
- 带宽 >= 100Mbps
- 操作系统: Ubuntu 20.04+ / CentOS 8+ / macOS 12+

### 必需的外部服务

- **Infura** 或其他以太坊RPC提供商
- **The Graph Studio** 账号 (用于子图部署)
- **MetaMask** 钱包 (用于部署和测试)
- **Etherscan API Key** (可选，用于合约验证)

## 开发环境搭建

### 1. 克隆项目

```bash
# 克隆项目到本地
git clone https://github.com/your-org/onchain-data-system.git
cd onchain-data-system

# 查看项目结构
ls -la
```

### 2. 安装依赖

```bash
# 安装根目录依赖
npm install

# 安装前端依赖
cd frontend
npm install

# 安装智能合约依赖
cd ../onchain-system-contracts
npm install

# 安装子图依赖
cd ../onchain-data-subgraph
npm install
```

### 3. 环境变量配置

#### 3.1 智能合约环境变量

创建 `onchain-system-contracts/.env` 文件：

```bash
# 网络配置
INFURA_PROJECT_ID=your_infura_project_id
SEPOLIA_RPC_URL=https://sepolia.infura.io/v3/your_infura_project_id
MAINNET_RPC_URL=https://mainnet.infura.io/v3/your_infura_project_id

# 私钥配置 (仅用于部署)
DEPLOYER_PRIVATE_KEY=your_deployer_private_key

# Etherscan API (用于合约验证)
ETHERSCAN_API_KEY=your_etherscan_api_key

# Gas配置
DEFAULT_GAS_PRICE=20000000000  # 20 Gwei
DEFAULT_GAS_LIMIT=8000000
```

#### 3.2 前端环境变量

创建 `frontend/.env` 文件：

```bash
# 基础配置
REACT_APP_NAME=链上数据系统
REACT_APP_VERSION=1.0.0

# RPC配置
REACT_APP_SEPOLIA_RPC_URL=https://sepolia.infura.io/v3/your_infura_project_id
REACT_APP_MAINNET_RPC_URL=https://mainnet.infura.io/v3/your_infura_project_id

# The Graph配置
REACT_APP_SUBGRAPH_URL=https://api.studio.thegraph.com/query/your_subgraph_id

# 合约地址 (部署后更新)
REACT_APP_DATA_STORAGE_CONTRACT=0x41dCf4E34eB2C231Cb03663D6e47ff271f621C4A
REACT_APP_USDC_CONTRACT=0x1c7D4B196Cb0C7B01d743Fbc6116a902379C7238

# 默认网络
REACT_APP_DEFAULT_CHAIN_ID=11155111

# 特性开关
REACT_APP_ENABLE_ANALYTICS=false
REACT_APP_ENABLE_SENTRY=false
REACT_APP_ENABLE_DEBUG=true
```

#### 3.3 子图环境变量

创建 `onchain-data-subgraph/.env` 文件：

```bash
# The Graph Studio配置
SUBGRAPH_NAME=your_subgraph_name
GRAPH_ACCESS_TOKEN=your_graph_access_token

# 合约配置
CONTRACT_ADDRESS=0x41dCf4E34eB2C231Cb03663D6e47ff271f621C4A
START_BLOCK=4500000
NETWORK=sepolia
```

### 4. 本地区块链环境 (可选)

如果需要在本地测试，可以使用Ganache:

```bash
# 全局安装Ganache CLI
npm install -g ganache-cli

# 启动本地区块链
ganache-cli \
  --accounts 10 \
  --balance 100 \
  --gasPrice 20000000000 \
  --gasLimit 8000000 \
  --port 8545 \
  --networkId 1337 \
  --deterministic
```

更新 `onchain-system-contracts/truffle-config.js` 添加本地网络：

```javascript
module.exports = {
  networks: {
    development: {
      host: "127.0.0.1",
      port: 8545,
      network_id: "1337",
      gas: 8000000,
      gasPrice: 20000000000
    },
    // ... 其他网络配置
  }
};
```

## 智能合约部署

### 1. 编译合约

```bash
cd onchain-system-contracts

# 编译所有合约
npx truffle compile

# 检查编译结果
ls build/contracts/
```

### 2. 部署到测试网

```bash
# 部署到Sepolia测试网
npx truffle migrate --network sepolia

# 查看部署结果
npx truffle networks

# 验证合约 (可选)
npx truffle run verify DataStorage --network sepolia
```

**部署成功后的输出示例**:
```
Deploying 'DataStorage'
-----------------------
> transaction hash:    0x1234567890abcdef...
> Blocks: 1            Seconds: 12
> contract address:    0x41dCf4E34eB2C231Cb03663D6e47ff271f621C4A
> block number:        4567890
> block timestamp:     1672531200
> account:             0xYourDeployerAddress
> balance:             1.5 ETH
> gas used:            1234567 (0x12d687)
> gas price:           20 gwei
> value sent:          0 ETH
> total cost:          0.02469134 ETH
```

### 3. 更新前端配置

将部署得到的合约地址更新到 `frontend/.env`:

```bash
REACT_APP_DATA_STORAGE_CONTRACT=0x41dCf4E34eB2C231Cb03663D6e47ff271f621C4A
```

复制ABI文件到前端：

```bash
# 复制ABI文件
cp build/contracts/DataStorage.json ../frontend/src/abi/
```

### 4. 合约交互测试

```bash
# 进入Truffle控制台
npx truffle console --network sepolia

# 在控制台中测试
truffle(sepolia)> const instance = await DataStorage.deployed()
truffle(sepolia)> await instance.storeData("Hello, Blockchain!")
truffle(sepolia)> const count = await instance.getDataCount()
truffle(sepolia)> console.log("数据总数:", count.toString())
```

## The Graph子图部署

### 1. 准备子图代码

```bash
cd onchain-data-subgraph

# 检查配置文件
cat subgraph.yaml
```

确认 `subgraph.yaml` 中的合约地址正确：

```yaml
dataSources:
  - kind: ethereum
    name: DataStorage
    network: sepolia
    source:
      address: "0x41dCf4E34eB2C231Cb03663D6e47ff271f621C4A"  # 使用实际部署地址
      abi: DataStorage
      startBlock: 4500000  # 使用合约部署的区块号
```

### 2. 生成代码和构建

```bash
# 生成AssemblyScript类型
npx graph codegen

# 构建子图
npx graph build

# 检查生成的文件
ls generated/
```

### 3. 创建和部署子图

```bash
# 登录到The Graph Studio
npx graph auth --studio your_deploy_key

# 创建子图 (首次部署)
npx graph create --studio onchain-data-system

# 部署子图
npx graph deploy --studio onchain-data-system

# 查看部署状态
npx graph status --studio onchain-data-system
```

### 4. 验证子图功能

部署成功后，在The Graph Studio中测试查询：

```graphql
# 测试查询
{
  dataStoredEvents(first: 5, orderBy: timestamp, orderDirection: desc) {
    id
    user
    message
    timestamp
    blockNumber
    transactionHash
  }
}
```

## 前端应用部署

### 1. 开发服务器启动

```bash
cd frontend

# 启动开发服务器
npm start

# 访问 http://localhost:3000
```

### 2. 生产构建

```bash
# 生产环境构建
npm run build

# 预览构建结果
npx serve -s build -p 3001
```

### 3. 部署到静态托管

#### 3.1 部署到Netlify

```bash
# 安装Netlify CLI
npm install -g netlify-cli

# 登录Netlify
netlify login

# 部署到Netlify
cd build
netlify deploy --prod --dir .
```

#### 3.2 部署到Vercel

```bash
# 安装Vercel CLI
npm install -g vercel

# 登录Vercel
vercel login

# 部署到Vercel
cd frontend
vercel --prod
```

#### 3.3 部署到AWS S3 + CloudFront

```bash
# 安装AWS CLI
pip install awscli

# 配置AWS凭证
aws configure

# 上传到S3
aws s3 sync build/ s3://your-bucket-name --delete

# 创建CloudFront分发
aws cloudfront create-distribution --distribution-config file://cloudfront-config.json
```

CloudFront配置文件示例 (`cloudfront-config.json`):

```json
{
  "CallerReference": "onchain-data-system-2023",
  "DefaultRootObject": "index.html",
  "Origins": {
    "Quantity": 1,
    "Items": [
      {
        "Id": "S3-onchain-data-system",
        "DomainName": "your-bucket-name.s3.amazonaws.com",
        "S3OriginConfig": {
          "OriginAccessIdentity": ""
        }
      }
    ]
  },
  "DefaultCacheBehavior": {
    "TargetOriginId": "S3-onchain-data-system",
    "ViewerProtocolPolicy": "redirect-to-https",
    "TrustedSigners": {
      "Enabled": false,
      "Quantity": 0
    },
    "ForwardedValues": {
      "QueryString": false,
      "Cookies": {"Forward": "none"}
    }
  },
  "Comment": "链上数据系统前端分发",
  "Enabled": true
}
```

### 4. 容器化部署

#### 4.1 Docker部署

创建 `frontend/Dockerfile`:

```dockerfile
# 多阶段构建
FROM node:18-alpine AS builder

WORKDIR /app

# 复制package文件并安装依赖
COPY package*.json ./
RUN npm ci --only=production

# 复制源码并构建
COPY . .
RUN npm run build

# 生产阶段
FROM nginx:1.21-alpine

# 复制构建结果和nginx配置
COPY --from=builder /app/build /usr/share/nginx/html
COPY nginx.conf /etc/nginx/nginx.conf

# 健康检查
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost/health || exit 1

# 暴露端口
EXPOSE 80

CMD ["nginx", "-g", "daemon off;"]
```

创建 `frontend/nginx.conf`:

```nginx
user nginx;
worker_processes auto;

error_log /var/log/nginx/error.log notice;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    
    access_log /var/log/nginx/access.log main;
    
    sendfile on;
    tcp_nopush on;
    keepalive_timeout 65;
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
    
    server {
        listen 80;
        server_name localhost;
        
        root /usr/share/nginx/html;
        index index.html;
        
        # 处理React Router
        location / {
            try_files $uri $uri/ /index.html;
        }
        
        # 健康检查端点
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
        
        # 静态资源缓存
        location /static/ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
        
        # 安全头设置
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;
        add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'" always;
    }
}
```

构建和运行Docker容器:

```bash
# 构建镜像
docker build -t onchain-data-system-frontend .

# 运行容器
docker run -d \
  --name onchain-data-frontend \
  -p 80:80 \
  --restart unless-stopped \
  onchain-data-system-frontend

# 查看日志
docker logs -f onchain-data-frontend
```

#### 4.2 Docker Compose部署

创建 `docker-compose.yml`:

```yaml
version: '3.8'

services:
  frontend:
    build: 
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "80:80"
    environment:
      - NODE_ENV=production
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # 可选：添加反向代理
  nginx-proxy:
    image: nginx:alpine
    ports:
      - "443:443"
    volumes:
      - ./nginx-proxy.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - frontend
    restart: unless-stopped

volumes:
  ssl_certs:
```

启动服务:

```bash
# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f frontend
```

## CI/CD流水线配置

### 1. GitHub Actions配置

创建 `.github/workflows/deploy.yml`:

```yaml
name: Deploy to Production

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '18'

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Run tests
        run: |
          cd frontend
          npm test -- --coverage --watchAll=false
      
      - name: Run linting
        run: |
          cd frontend
          npm run lint
      
      - name: Security audit
        run: |
          cd frontend
          npm audit --audit-level high

  build-contracts:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install contract dependencies
        run: |
          cd onchain-system-contracts
          npm ci
      
      - name: Compile contracts
        run: |
          cd onchain-system-contracts
          npx truffle compile
      
      - name: Test contracts
        run: |
          cd onchain-system-contracts
          npx truffle test
      
      - name: Deploy contracts (if changed)
        run: |
          cd onchain-system-contracts
          # 检查合约是否有变更
          if git diff --name-only HEAD~1 | grep -q "contracts/"; then
            npx truffle migrate --network sepolia --reset
          fi
        env:
          INFURA_PROJECT_ID: ${{ secrets.INFURA_PROJECT_ID }}
          DEPLOYER_PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}

  deploy-subgraph:
    runs-on: ubuntu-latest
    needs: [build-contracts]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install subgraph dependencies
        run: |
          cd onchain-data-subgraph
          npm ci
      
      - name: Generate and build subgraph
        run: |
          cd onchain-data-subgraph
          npx graph codegen
          npx graph build
      
      - name: Deploy subgraph
        run: |
          cd onchain-data-subgraph
          npx graph deploy --studio ${{ secrets.SUBGRAPH_NAME }}
        env:
          GRAPH_ACCESS_TOKEN: ${{ secrets.GRAPH_ACCESS_TOKEN }}

  deploy-frontend:
    runs-on: ubuntu-latest
    needs: [test, deploy-subgraph]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Build frontend
        run: |
          cd frontend
          npm run build
        env:
          REACT_APP_SUBGRAPH_URL: ${{ secrets.REACT_APP_SUBGRAPH_URL }}
          REACT_APP_DATA_STORAGE_CONTRACT: ${{ secrets.REACT_APP_DATA_STORAGE_CONTRACT }}
      
      - name: Deploy to S3
        run: |
          cd frontend
          aws s3 sync build/ s3://${{ secrets.S3_BUCKET }} --delete
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      
      - name: Invalidate CloudFront
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} \
            --paths "/*"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: ${{ secrets.AWS_DEFAULT_REGION }}
      
      - name: Notify deployment
        run: |
          echo "✅ 部署完成！访问地址: https://${{ secrets.DOMAIN_NAME }}"
```

### 2. 环境分离

为不同环境创建不同的配置文件:

**开发环境** (`frontend/.env.development`):
```bash
REACT_APP_ENVIRONMENT=development
REACT_APP_SEPOLIA_RPC_URL=https://sepolia.infura.io/v3/your_dev_key
REACT_APP_SUBGRAPH_URL=https://api.studio.thegraph.com/query/dev_subgraph_id
REACT_APP_ENABLE_DEBUG=true
```

**测试环境** (`frontend/.env.staging`):
```bash
REACT_APP_ENVIRONMENT=staging
REACT_APP_SEPOLIA_RPC_URL=https://sepolia.infura.io/v3/your_staging_key
REACT_APP_SUBGRAPH_URL=https://api.studio.thegraph.com/query/staging_subgraph_id
REACT_APP_ENABLE_DEBUG=false
```

**生产环境** (`frontend/.env.production`):
```bash
REACT_APP_ENVIRONMENT=production
REACT_APP_MAINNET_RPC_URL=https://mainnet.infura.io/v3/your_prod_key
REACT_APP_SUBGRAPH_URL=https://api.studio.thegraph.com/query/prod_subgraph_id
REACT_APP_ENABLE_DEBUG=false
REACT_APP_ENABLE_ANALYTICS=true
```

## 监控和日志

### 1. 应用监控设置

#### 1.1 Sentry集成

```bash
# 安装Sentry SDK
cd frontend
npm install @sentry/react @sentry/tracing
```

在 `frontend/src/index.tsx` 中配置Sentry:

```typescript
import * as Sentry from "@sentry/react";
import { BrowserTracing } from "@sentry/tracing";

if (process.env.REACT_APP_ENABLE_SENTRY === 'true') {
  Sentry.init({
    dsn: process.env.REACT_APP_SENTRY_DSN,
    integrations: [
      new BrowserTracing({
        tracingOrigins: ["localhost", /^https:\/\/yourapi\.domain\.com\/api/],
      }),
    ],
    tracesSampleRate: 0.1,
    environment: process.env.REACT_APP_ENVIRONMENT || 'development',
  });
}
```

#### 1.2 Google Analytics集成

```bash
# 安装GA4
npm install @google-analytics/gtag
```

在 `frontend/src/utils/analytics.ts` 中配置:

```typescript
import { gtag } from '@google-analytics/gtag';

class Analytics {
  private initialized = false;

  init(): void {
    if (process.env.REACT_APP_ENABLE_ANALYTICS === 'true' && 
        process.env.REACT_APP_GA_ID) {
      gtag('config', process.env.REACT_APP_GA_ID);
      this.initialized = true;
    }
  }

  trackEvent(event: string, parameters?: any): void {
    if (this.initialized) {
      gtag('event', event, parameters);
    }
  }

  trackPageView(page: string): void {
    if (this.initialized) {
      gtag('config', process.env.REACT_APP_GA_ID!, {
        page_path: page,
      });
    }
  }
}

export const analytics = new Analytics();
```

### 2. 性能监控

#### 2.1 Web Vitals监控

```bash
npm install web-vitals
```

在 `frontend/src/reportWebVitals.ts`:

```typescript
import { ReportHandler } from 'web-vitals';

const reportWebVitals = (onPerfEntry?: ReportHandler) => {
  if (onPerfEntry && onPerfEntry instanceof Function) {
    import('web-vitals').then(({ getCLS, getFID, getFCP, getLCP, getTTFB }) => {
      getCLS(onPerfEntry);
      getFID(onPerfEntry);
      getFCP(onPerfEntry);
      getLCP(onPerfEntry);
      getTTFB(onPerfEntry);
    });
  }
};

export default reportWebVitals;
```

#### 2.2 自定义性能监控

```typescript
// frontend/src/utils/performance.ts
class PerformanceMonitor {
  private metrics = new Map<string, number>();

  startTimer(name: string): void {
    this.metrics.set(`${name}_start`, performance.now());
  }

  endTimer(name: string): number {
    const startTime = this.metrics.get(`${name}_start`);
    if (startTime) {
      const duration = performance.now() - startTime;
      this.metrics.set(name, duration);
      
      // 发送到监控服务
      this.sendMetric(name, duration);
      
      return duration;
    }
    return 0;
  }

  private async sendMetric(name: string, value: number): Promise<void> {
    if (process.env.REACT_APP_ENABLE_ANALYTICS === 'true') {
      try {
        await fetch('/api/metrics', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name,
            value,
            timestamp: Date.now(),
            url: window.location.pathname
          })
        });
      } catch (error) {
        console.warn('Failed to send metric:', error);
      }
    }
  }
}

export const performanceMonitor = new PerformanceMonitor();
```

### 3. 日志收集

#### 3.1 结构化日志

```typescript
// frontend/src/utils/logger.ts
enum LogLevel {
  DEBUG = 0,
  INFO = 1,
  WARN = 2,
  ERROR = 3
}

class Logger {
  private level: LogLevel = process.env.NODE_ENV === 'development' 
    ? LogLevel.DEBUG 
    : LogLevel.INFO;

  private log(level: LogLevel, message: string, extra?: any): void {
    if (level < this.level) return;

    const logEntry = {
      timestamp: new Date().toISOString(),
      level: LogLevel[level],
      message,
      extra,
      url: window.location.href,
      userAgent: navigator.userAgent,
      sessionId: this.getSessionId()
    };

    // 控制台输出
    const consoleMethods = [console.debug, console.info, console.warn, console.error];
    consoleMethods[level](JSON.stringify(logEntry));

    // 发送到日志服务
    if (level >= LogLevel.WARN) {
      this.sendToLogService(logEntry);
    }
  }

  debug(message: string, extra?: any): void {
    this.log(LogLevel.DEBUG, message, extra);
  }

  info(message: string, extra?: any): void {
    this.log(LogLevel.INFO, message, extra);
  }

  warn(message: string, extra?: any): void {
    this.log(LogLevel.WARN, message, extra);
  }

  error(message: string, error?: Error, extra?: any): void {
    this.log(LogLevel.ERROR, message, {
      error: error?.message,
      stack: error?.stack,
      ...extra
    });
  }

  private getSessionId(): string {
    let sessionId = sessionStorage.getItem('sessionId');
    if (!sessionId) {
      sessionId = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
      sessionStorage.setItem('sessionId', sessionId);
    }
    return sessionId;
  }

  private async sendToLogService(logEntry: any): Promise<void> {
    try {
      await fetch('/api/logs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(logEntry)
      });
    } catch (error) {
      console.error('Failed to send log to service:', error);
    }
  }
}

export const logger = new Logger();
```

### 4. 健康检查

#### 4.1 前端健康检查

```typescript
// frontend/src/utils/healthCheck.ts
interface HealthStatus {
  status: 'healthy' | 'degraded' | 'unhealthy';
  checks: {
    rpc: boolean;
    subgraph: boolean;
    localStorage: boolean;
  };
  timestamp: number;
}

export class HealthChecker {
  async checkHealth(): Promise<HealthStatus> {
    const checks = await Promise.allSettled([
      this.checkRPC(),
      this.checkSubgraph(),
      this.checkLocalStorage()
    ]);

    const results = {
      rpc: checks[0].status === 'fulfilled' && checks[0].value,
      subgraph: checks[1].status === 'fulfilled' && checks[1].value,
      localStorage: checks[2].status === 'fulfilled' && checks[2].value
    };

    const healthyCount = Object.values(results).filter(Boolean).length;
    let status: HealthStatus['status'] = 'unhealthy';

    if (healthyCount === 3) {
      status = 'healthy';
    } else if (healthyCount >= 2) {
      status = 'degraded';
    }

    return {
      status,
      checks: results,
      timestamp: Date.now()
    };
  }

  private async checkRPC(): Promise<boolean> {
    try {
      const provider = new ethers.JsonRpcProvider(process.env.REACT_APP_SEPOLIA_RPC_URL);
      await provider.getBlockNumber();
      return true;
    } catch {
      return false;
    }
  }

  private async checkSubgraph(): Promise<boolean> {
    try {
      const response = await fetch(process.env.REACT_APP_SUBGRAPH_URL!, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          query: '{ _meta { block { number } } }'
        })
      });
      return response.ok;
    } catch {
      return false;
    }
  }

  private checkLocalStorage(): boolean {
    try {
      const testKey = '__health_check__';
      localStorage.setItem(testKey, 'test');
      localStorage.removeItem(testKey);
      return true;
    } catch {
      return false;
    }
  }
}
```

## 故障排除

### 常见问题和解决方案

#### 1. 智能合约部署问题

**问题**: Gas估算失败
```bash
Error: gas required exceeds allowance or always failing transaction
```

**解决方案**:
```bash
# 1. 检查账户余额
npx truffle console --network sepolia
truffle(sepolia)> web3.eth.getBalance("YOUR_ACCOUNT_ADDRESS")

# 2. 增加Gas限制
# 在truffle-config.js中增加gas限制
networks: {
  sepolia: {
    gas: 8000000,  // 增加Gas限制
    gasPrice: 20000000000  // 或降低Gas价格
  }
}

# 3. 检查合约代码
npx truffle compile --all
```

#### 2. 前端连接问题

**问题**: MetaMask连接失败
```javascript
Error: MetaMask not found
```

**解决方案**:
```typescript
// 添加详细的错误处理
const connectWallet = async () => {
  // 检查是否安装MetaMask
  if (typeof window.ethereum === 'undefined') {
    alert('请安装MetaMask!');
    window.open('https://metamask.io/download/', '_blank');
    return;
  }

  // 检查网络
  const chainId = await window.ethereum.request({ method: 'eth_chainId' });
  if (chainId !== '0xaa36a7') {  // Sepolia
    await window.ethereum.request({
      method: 'wallet_switchEthereumChain',
      params: [{ chainId: '0xaa36a7' }],
    });
  }

  // 请求连接
  await window.ethereum.request({ method: 'eth_requestAccounts' });
};
```

#### 3. The Graph查询问题

**问题**: 子图同步延迟
```
Subgraph is not synced yet
```

**解决方案**:
```bash
# 1. 检查子图状态
curl -X POST \
  -H "Content-Type: application/json" \
  -d '{"query": "{ _meta { block { number } } }"}' \
  YOUR_SUBGRAPH_URL

# 2. 如果同步慢，使用直接RPC查询作为降级方案
const fetchData = async () => {
  try {
    return await fetchFromSubgraph();
  } catch (error) {
    console.warn('Subgraph unavailable, falling back to RPC');
    return await fetchFromRPC();
  }
};
```

#### 4. 性能问题

**问题**: 页面加载慢

**解决方案**:
```typescript
// 1. 启用代码分割
const LazyComponent = React.lazy(() => import('./Component'));

// 2. 优化查询
const OPTIMIZED_QUERY = `
  query GetData($first: Int!, $skip: Int!) {
    dataStoredEvents(
      first: $first
      skip: $skip
      orderBy: blockNumber
      orderDirection: desc
    ) {
      id
      user
      message
      timestamp
      # 只查询必要字段
    }
  }
`;

// 3. 添加缓存
const { data } = useQuery(['data', page], 
  () => fetchData(page), 
  { staleTime: 60000 }  // 缓存1分钟
);
```

### 调试工具

#### 1. 调试脚本

创建 `scripts/debug.js`:

```javascript
const { ethers } = require("ethers");
const DataStorageABI = require("../frontend/src/abi/DataStorage.json");

async function debugContract() {
  const provider = new ethers.JsonRpcProvider(process.env.SEPOLIA_RPC_URL);
  const contract = new ethers.Contract(
    process.env.REACT_APP_DATA_STORAGE_CONTRACT,
    DataStorageABI.abi,
    provider
  );

  console.log("=== 合约调试信息 ===");
  
  try {
    const count = await contract.getDataCount();
    console.log("数据总数:", count.toString());

    const latest = await contract.getData(count - 1n);
    console.log("最新数据:", {
      user: latest.user,
      message: latest.message,
      timestamp: new Date(Number(latest.timestamp) * 1000).toLocaleString()
    });

  } catch (error) {
    console.error("调试失败:", error);
  }
}

debugContract();
```

运行调试:
```bash
node scripts/debug.js
```

#### 2. 网络状态检查

创建 `scripts/network-check.js`:

```javascript
const { ethers } = require("ethers");

async function checkNetwork() {
  const provider = new ethers.JsonRpcProvider(process.env.SEPOLIA_RPC_URL);
  
  try {
    const network = await provider.getNetwork();
    const blockNumber = await provider.getBlockNumber();
    const gasPrice = await provider.getFeeData();
    
    console.log("=== 网络状态 ===");
    console.log("网络:", network.name, "(Chain ID:", network.chainId, ")");
    console.log("最新区块:", blockNumber);
    console.log("Gas价格:", ethers.formatUnits(gasPrice.gasPrice, "gwei"), "Gwei");
    
    // 测试连接延迟
    const start = Date.now();
    await provider.getBlockNumber();
    const latency = Date.now() - start;
    console.log("连接延迟:", latency, "ms");
    
  } catch (error) {
    console.error("网络检查失败:", error);
  }
}

checkNetwork();
```

这份详细的部署运行指南涵盖了从开发环境搭建到生产环境部署的所有步骤。通过遵循本指南，您可以成功部署和运维链上数据系统。如遇到问题，请参考故障排除部分或查看项目日志进行调试。